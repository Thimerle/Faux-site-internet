<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Temu‑Demo — Panier</title>
    <style>
        :root{--accent:#ff3b30;--muted:#888}
        .promo-banner{background:linear-gradient(90deg,#ff8a65,#ff3b30);color:#fff;padding:10px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
        .badge{background:#ff3b30;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700}
        .countdown{font-weight:700}
        body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f7f7fb;margin:0;padding:24px}
        .app{max-width:980px;margin:0 auto;display:flex;gap:24px}
        .catalog{flex:2;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
        .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
        .card img{width:100%;height:140px;object-fit:cover;border-radius:8px}
        .card h3{margin:8px 0 6px;font-size:15px}
        .price{font-weight:700;color:#111}
        .muted{color:var(--muted);font-size:13px}
        .aside{width:320px}
        .panel{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
        .cart-list{margin:12px 0;display:flex;flex-direction:column;gap:8px}
        .cart-item{display:flex;gap:8px;align-items:center}
        .cart-item img{width:56px;height:56px;object-fit:cover;border-radius:8px}
        button{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
        button:disabled{opacity:.6;cursor:not-allowed}
        .error{margin-top:12px;padding:12px;background:#fff0f0;border:1px solid #ffb6b6;border-radius:8px;color:#a00;display:none}
        header{max-width:980px;margin:0 auto;padding-bottom:12px}
        h1{font-size:20px;margin:0 0 12px}
    </style>
</head>
<body>
    <header style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
            <h1 style="margin:0">Shop — Boutique</h1>
            <div class="muted">Large choix, petits prix</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
            <input id="search" placeholder="Rechercher des produits" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;width:320px">
            <select id="sort" style="padding:8px;border-radius:8px;border:1px solid #ddd">
                <option value="default">Trier</option>
                <option value="price-asc">Prix croissant</option>
                <option value="price-desc">Prix décroissant</option>
                <option value="title">Nom</option>
            </select>
            <div id="authLinks" style="margin-left:12px"></div>
        </div>
    </header>

    <div class="promo-banner" id="promoBanner">
        <div><span class="badge">Flash</span>&nbsp;Offres limitées — jusqu'à -30% sur une sélection</div>
        <div>Termine dans <span class="countdown" id="promoCountdown">--:--:--</span></div>
    </div>

    <main class="app">
        <section style="flex:2">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div class="muted">Affichage des produits</div>
                <div class="muted" id="count"></div>
            </div>
            <div class="catalog" id="catalog">
                <!-- produits injectés par JS -->
            </div>
        </section>

        <aside class="aside">
            <div class="panel">
                <h2>Panier</h2>
                <div id="cart" class="cart-list">
                    <div class="muted">Votre panier est vide</div>
                </div>
                <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
                    <div style="flex:1">
                        <div class="muted">Total</div>
                        <div id="total" style="font-weight:700">0,00€</div>
                        <div id="discountLine" class="muted" style="font-size:13px;margin-top:6px;display:none">Remise appliquée : -0%</div>
                    </div>
                    <div style="width:140px">
                        <button id="checkoutBtn">Payer</button>
                    </div>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                    <input id="promoCode" placeholder="Code promo" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd">
                    <button id="applyPromo" style="background:#333">Appliquer</button>
                </div>

                <div id="errorBox" class="error"></div>
            </div>
        </aside>
    </main>

    <script type="module">
        import { API_BASE_URL } from './config.js';

        let products = [];
        const catalog = document.getElementById('catalog');
        const cartEl = document.getElementById('cart');
        const totalEl = document.getElementById('total');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const errorBox = document.getElementById('errorBox');

        function loadCart(){ try{ return JSON.parse(localStorage.getItem('fs_cart')||'{}'); }catch(e){ return {} }}
        function saveCart(){ try{ localStorage.setItem('fs_cart', JSON.stringify(cart)); }catch(e){} }
        const cart = loadCart();

        // promotions / codes
        const saleIds = [2,5,6,15]; // produits en promotion
        const salePercent = 0.30; // 30% off
        const promoCodes = {"PROMO10":0.10, "DEAL20":0.20};
        let appliedPromo = null;
        const promoEnd = Date.now() + 6*60*60*1000; // promo 6 heures

        function formatTimeLeft(ms){
            if(ms<=0) return '00:00:00';
            const s = Math.floor(ms/1000);
            const h = String(Math.floor(s/3600)).padStart(2,'0');
            const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
            const sec = String(s%60).padStart(2,'0');
            return `${h}:${m}:${sec}`;
        }

        function startPromoCountdown(){
            const el = document.getElementById('promoCountdown');
            const banner = document.getElementById('promoBanner');
            const t = setInterval(()=>{
                const left = promoEnd - Date.now();
                if(left<=0){ el.textContent='00:00:00'; banner.style.display='none'; clearInterval(t); renderCatalog(); return }
                el.textContent = formatTimeLeft(left);
            },1000);
        }

        function applyPromo(code){
            if(!code) return {ok:false,msg:'Entrez un code.'};
            const up = (code||'').trim().toUpperCase();
            if(!promoCodes[up]) return {ok:false,msg:'Code invalide.'};
            appliedPromo = {code:up, pct: promoCodes[up]};
            return {ok:true,msg:`Remise ${Math.round(promoCodes[up]*100)}% appliquée`};
        }

        function openProduct(id){
            const p = products.find(x=>x.id==id);
            const modal = document.createElement('div');
            modal.style.position='fixed';modal.style.left=0;modal.style.top=0;modal.style.right=0;modal.style.bottom=0;modal.style.background='rgba(0,0,0,0.4)';modal.style.display='flex';modal.style.alignItems='center';modal.style.justifyContent='center';
            modal.innerHTML = `<div style="width:680px;background:#fff;border-radius:12px;padding:16px"><div style='display:flex;gap:12px'><img src="${p.img}" style='width:260px;height:180px;object-fit:cover;border-radius:8px'><div style='flex:1'><h2 style='margin:0'>${p.title}</h2><div class='muted'>${p.desc}</div><div style='margin-top:12px;font-weight:700'>${p.price.toFixed(2)}€</div><div style='margin-top:12px;display:flex;gap:8px'><button id='modalAdd'>Ajouter au panier</button><button id='modalClose' style='background:#ddd;color:#111'>Fermer</button></div></div></div></div>`;
            document.body.appendChild(modal);
            modal.querySelector('#modalClose').addEventListener('click',()=>modal.remove());
            modal.querySelector('#modalAdd').addEventListener('click',()=>{cart[id]=(cart[id]||0)+1; saveCart(); renderCart(); modal.remove()});
        }

        function renderCatalog(){
            catalog.innerHTML = '';
            let visible = products.slice();
            // search
            const q = (document.getElementById('search').value||'').toLowerCase().trim();
            if(q) visible = visible.filter(p=> (p.title+' '+p.desc).toLowerCase().includes(q));
            // sort
            const s = document.getElementById('sort').value;
            if(s==='price-asc') visible.sort((a,b)=>a.price-b.price);
            if(s==='price-desc') visible.sort((a,b)=>b.price-a.price);
            if(s==='title') visible.sort((a,b)=>a.title.localeCompare(b.title));

            document.getElementById('count').textContent = visible.length+' produits';
            visible.forEach(p=>{
                const onSale = saleIds.includes(p.id) && (Date.now() < promoEnd);
                const card = document.createElement('div'); card.className='card';
                card.innerHTML = `
                    ${onSale?'<div style="position:absolute;margin:8px;z-index:2"><span class="badge">-${Math.round(salePercent*100)}%</span></div>':''}
                    <img src="${p.img}" alt="${p.title}">
                    <h3>${p.title}</h3>
                    <div class="price">${onSale?`<span style="text-decoration:line-through;color:#999;margin-right:6px">${p.price.toFixed(2)}€</span><span>${(p.price*(1-salePercent)).toFixed(2)}€</span>`:`${p.price.toFixed(2)}€`}</div>
                    <div class="muted">Livraison gratuite</div>
                    <div style="margin-top:8px;display:flex;gap:8px"><button data-id="${p.id}" class='addBtn'>Ajouter</button><button data-id="${p.id}" class='viewBtn' style='background:#fff;color:#111;border:1px solid #ddd'>Voir</button></div>`;
                catalog.appendChild(card);
            });
            catalog.querySelectorAll('button.addBtn').forEach(b=>b.addEventListener('click',e=>{
                const id = Number(e.currentTarget.dataset.id); cart[id] = (cart[id]||0)+1; saveCart(); renderCart();
            }));
            catalog.querySelectorAll('button.viewBtn').forEach(b=>b.addEventListener('click',e=>{
                openProduct(Number(e.currentTarget.dataset.id));
            }));
        }

        function renderCart(){
            cartEl.innerHTML = '';
            const ids = Object.keys(cart);
            if(ids.length===0){cartEl.innerHTML = '<div class="muted">Votre panier est vide</div>'; totalEl.textContent='0,00€'; return}
            let total = 0;
            ids.forEach(id=>{
                const p = products.find(x=>x.id==id);
                const qty = cart[id];
                const onSale = saleIds.includes(p.id) && (Date.now() < promoEnd);
                const unitPrice = onSale ? (p.price*(1-salePercent)) : p.price;
                total += unitPrice*qty;
                const item = document.createElement('div'); item.className='cart-item';
                item.innerHTML = `<img src="${p.img}" alt=""><div style="flex:1"><div>${p.title}</div><div class=\"muted\">${qty} × ${p.price.toFixed(2)}€</div></div><div><button data-id="${id}" class="remove">–</button></div>`;
                cartEl.appendChild(item);
            });
            // apply promo code
            let finalTotal = total;
            if(appliedPromo){
                const discount = finalTotal * appliedPromo.pct;
                finalTotal = finalTotal - discount;
                document.getElementById('discountLine').style.display = 'block';
                document.getElementById('discountLine').textContent = `Remise appliquée (${appliedPromo.code}) : -${Math.round(appliedPromo.pct*100)}% (${discount.toFixed(2)}€)`;
            } else {
                document.getElementById('discountLine').style.display = 'none';
            }
            totalEl.textContent = finalTotal.toFixed(2)+'€';
            cartEl.querySelectorAll('button.remove').forEach(b=>b.addEventListener('click',e=>{
                const id = e.currentTarget.dataset.id; cart[id]--; if(cart[id]<=0) delete cart[id]; saveCart(); renderCart();
            }));
        }

        checkoutBtn.addEventListener('click', ()=>{
            // comportement volontaire : échec systématique
            errorBox.textContent = 'Erreur 500 : échec du paiement — code #ERR500';
            errorBox.style.display = 'block';
            checkoutBtn.disabled = true;
        });

        // events
        document.getElementById('search').addEventListener('input',renderCatalog);
        document.getElementById('sort').addEventListener('change',renderCatalog);

        // promo apply handler
        document.getElementById('applyPromo').addEventListener('click', ()=>{
            const code = document.getElementById('promoCode').value || '';
            const res = applyPromo(code);
            if(!res.ok){ alert(res.msg); return }
            alert(res.msg);
            renderCart();
        });

        // fetch products from API then render
        (async ()=>{
            try{
                const r = await fetch(`${API_BASE_URL}/api/products`);
                if(r.ok) products = await r.json();
            }catch(e){ console.warn('Impossible de charger produits depuis API, fallback au client-side.'); }
            startPromoCountdown();
            renderCatalog();
            renderCart();
        })();
    </script>
</body>
</html>
